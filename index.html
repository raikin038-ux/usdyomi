<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>USD/JPY 15åˆ†è¶³ äºˆæ¸¬ï¼ˆiPhoneå¯¾å¿œ CPUå›ºå®šï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Chart.js / TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

<style>
  body { font-family:-apple-system, BlinkMacSystemFont, "Hiragino Sans", Meiryo, sans-serif;
         background:#fafafa; margin:0; color:#222; }
  header { background:#fff; padding:12px; border-bottom:1px solid #eee; }
  h1 { margin:0; font-size:16px; }
  main { max-width:100%; padding:10px; }
  .panel { background:#fff; border:1px solid #eee; border-radius:12px; padding:10px; margin:10px 0; }
  input,select,button{ font-size:14px; padding:6px 8px; }
  button{ border-radius:8px; border:1px solid #ccc; background:#eee; }
  button.primary{ background:#222; color:#fff; border-color:#222; }
  .row{ display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
  canvas{ width:100%!important; height:auto!important; }
  footer{ text-align:center; font-size:11px; color:#888; padding:8px; }
</style>

<!-- âœ… CPUå›ºå®šåŒ– -->
<script>
(async()=>{
  if(typeof tf==="undefined") return;
  try{
    await tf.setBackend("cpu");
    await tf.ready();
    console.log("âœ… TensorFlow.js backend=CPUï¼ˆiPhoneå¯¾å¿œï¼‰");
    document.title+=" | CPU";
  }catch(e){
    console.warn("TF init error:",e);
    alert("TensorFlowåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Safariã®è¨­å®šã§JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚");
  }
})();
</script>
</head>

<body>
<header><h1>ğŸ’± USD/JPY 15åˆ†è¶³ äºˆæ¸¬ï¼ˆiPhone CPUå›ºå®šï¼‰</h1></header>
<main>
  <div class="panel">
    <div class="row">
      <div><label>lookback</label><input id="lookback" type="number" value="64"></div>
      <div><label>epochs</label><input id="epochs" type="number" value="18"></div>
      <div><label>å­¦ç¿’ç‡</label><input id="lr" type="number" step="0.0001" value="0.001"></div>
      <div><label>Yahooç¯„å›²</label>
        <select id="rangeSel">
          <option value="5d" selected>éå»5æ—¥</option>
          <option value="1mo">1ã‹æœˆ</option>
        </select>
      </div>
    </div>
    <div class="row" style="margin-top:6px;">
      <button id="initBtn" class="primary">åˆæœŸå–å¾—</button>
      <button id="startBtn">å­¦ç¿’ï¼‹äºˆæ¸¬</button>
      <button id="autoBtn">è‡ªå‹•æ›´æ–°: OFF</button>
    </div>
    <div id="status" style="font-size:12px;color:#555;margin-top:6px;">æº–å‚™OK</div>
  </div>

  <div class="panel"><canvas id="chart" height="320"></canvas></div>
  <div class="panel">
    <div>æœ€æ–°å€¤: <span id="curPrice">-</span></div>
    <div>15åˆ†å¾Œäºˆæ¸¬: <span id="pred15" style="font-weight:bold;">-</span></div>
    <div>å‚¾å‘: <span id="trend15">-</span></div>
  </div>
</main>

<footer>Â© iPhone Optimized USD/JPY Predictor â€” BiLSTM + CPU Mode</footer>

<script>
const $=id=>document.getElementById(id);
let closes=[],times=[];

// Yahooå–å¾—ï¼ˆAllOriginsï¼‰
async function fetchYahoo(){
  $("status").textContent="ãƒ‡ãƒ¼ã‚¿å–å¾—ä¸­â€¦";
  const url=`https://api.allorigins.win/raw?url=${encodeURIComponent(
    "https://query1.finance.yahoo.com/v7/finance/chart/USDJPY=X?range=5d&interval=15m&indicators=quote&includeTimestamps=true"
  )}`;
  const res=await fetch(url);
  const j=await res.json();
  const r=j?.chart?.result?.[0];
  const ts=r?.timestamp||[]; const c=r?.indicators?.quote?.[0]?.close||[];
  closes=[]; times=[];
  ts.forEach((t,i)=>{ if(Number.isFinite(c[i])){ closes.push(c[i]); times.push(new Date(t*1000).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"})); }});
  $("curPrice").textContent=closes.at(-1)?.toFixed(3)||"-";
  drawChart();
  $("status").textContent="å–å¾—å®Œäº†ï¼ˆ"+closes.length+"ä»¶ï¼‰";
}

// ç°¡æ˜“BiLSTMå­¦ç¿’ï¼‹äºˆæ¸¬ï¼ˆCPUãƒ¢ãƒ¼ãƒ‰ï¼‰
async function predictNext(){
  if(closes.length<64){ alert("ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™"); return; }
  $("status").textContent="å­¦ç¿’ä¸­â€¦(CPU)";
  const lookback=parseInt($("lookback").value)||64;
  const lr=parseFloat($("lr").value)||0.001;
  const epochs=parseInt($("epochs").value)||18;
  const series=tf.tensor2d(closes.slice(-lookback).map(v=>[v]));
  const x=[]; const y=[];
  for(let i=0;i<lookback-1;i++){ x.push(closes.slice(i,i+1)); y.push(closes[i+1]); }
  const tx=tf.tensor2d(x); const ty=tf.tensor2d(y,[y.length,1]);
  const m=tf.sequential();
  m.add(tf.layers.lstm({units:16,inputShape:[1,1]}));
  m.add(tf.layers.dense({units:1}));
  m.compile({optimizer:tf.train.adam(lr),loss:"meanSquaredError"});
  await m.fit(tx.reshape([x.length,1,1]),ty,{epochs,verbose:0});
  const px=tf.tensor3d([[closes.slice(-1)]]); const p=(await m.predict(px).array())[0][0];
  $("pred15").textContent=p.toFixed(4);
  $("trend15").textContent=p>closes.at(-1)?"ä¸Šæ˜‡ğŸ“ˆ":"ä¸‹é™ğŸ“‰";
  $("status").textContent="äºˆæ¸¬å®Œäº†";
  px.dispose(); tx.dispose(); ty.dispose(); m.dispose();
}

// Chart.js
function drawChart(){
  const ctx=$("chart");
  if(window.myChart)window.myChart.destroy();
  window.myChart=new Chart(ctx,{
    type:"line",
    data:{labels:times,datasets:[{label:"USD/JPY",data:closes,borderColor:"#007bff",pointRadius:0}]},
    options:{responsive:true,maintainAspectRatio:false}
  });
}

// ãƒœã‚¿ãƒ³å‹•ä½œ
$("initBtn").onclick=fetchYahoo;
$("startBtn").onclick=predictNext;
</script>
</body>
</html>
