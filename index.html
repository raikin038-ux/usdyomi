<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>USD/JPY 15åˆ†è¶³ äºˆæ¸¬ï¼ˆiPhoneå¯¾å¿œãƒ»CPUå›ºå®šãƒ»å…¨æ©Ÿèƒ½ç¶­æŒï¼‰</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- Chart.js / TensorFlow.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.22.0/dist/tf.min.js"></script>

<style>
  :root { --w: 100%; }
  body { font-family:-apple-system,BlinkMacSystemFont,"Hiragino Sans",Meiryo,sans-serif;
         background:#fafafa; margin:0; color:#222; }
  header { padding:12px; background:#fff; border-bottom:1px solid #eee; position:sticky; top:0; z-index:9; }
  h1 { font-size:16px; margin:0; line-height:1.3; }
  main { max-width:1180px; margin:0 auto; padding:10px; }
  .panel { background:#fff; border:1px solid #eee; border-radius:12px; padding:10px; margin:10px 0; }
  .row { display:flex; flex-wrap:wrap; gap:10px; align-items:flex-end; }
  input,select,button { font-size:14px; padding:6px 8px; }
  button { border:1px solid #ccc; border-radius:8px; background:#eee; cursor:pointer; }
  button.primary { background:#222; color:#fff; border-color:#222; }
  .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(260px,1fr)); gap:10px; }
  .card { background:#fff; border:1px solid #eee; border-radius:10px; padding:10px; }
  .kv { font-size:20px; font-weight:bold; }
  .rationale { font-size:12px; white-space:pre-line; }
  canvas { width:100%!important; max-height:360px; }
  footer { text-align:center; font-size:11px; color:#888; padding:10px; }
  .progress-bar-fill { background:linear-gradient(90deg,#007bff,#00c6ff); height:6px; border-radius:6px; transition:width .25s; }
</style>

<!-- âœ… TensorFlow CPUå›ºå®šï¼ˆiPhoneå®‰å®šåŒ–ï¼‰ -->
<script>
(async()=>{
  if(typeof tf==="undefined") return;
  try{
    await tf.setBackend("cpu");
    await tf.ready();
    console.log("âœ… TensorFlow.js backend=CPU (iPhone Safe)");
    document.title+=" | CPU";
  }catch(e){
    console.error("TF init failed:",e);
    alert("TensorFlowåˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Safariã®è¨­å®šã§JavaScriptã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„ã€‚");
  }
})();
</script>
</head>

<body>
<header><h1>ğŸ’± USD/JPY 15åˆ†è¶³ äºˆæ¸¬ï¼ˆiPhone CPUå›ºå®šãƒ»å…¨æ©Ÿèƒ½ç‰ˆï¼‰</h1></header>
<main>

<!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« -->
<div class="panel">
  <div class="row">
    <div><label>lookback</label><input id="lookback" type="number" value="64"></div>
    <div><label>epochs</label><input id="epochs" type="number" value="18"></div>
    <div><label>å­¦ç¿’ç‡</label><input id="lr" type="number" step="0.0001" value="0.001"></div>
    <div><label>ä¿å­˜ä¸Šé™</label><input id="dbCap" type="number" value="60000"></div>
    <div><label>Yahooç¯„å›²</label>
      <select id="rangeSel">
        <option value="5d" selected>éå»5æ—¥</option>
        <option value="1mo">éå»1ãƒ¶æœˆ</option>
      </select>
    </div>
  </div>
  <div class="row" style="margin-top:8px;">
    <button id="initBtn" class="primary">åˆæœŸå–å¾—</button>
    <button id="startBtn">å­¦ç¿’ï¼‹äºˆæ¸¬</button>
    <button id="autoBtn">è‡ªå‹•æ›´æ–°: OFF</button>
    <button id="clearBtn">ä¿å­˜ãƒ‡ãƒ¼ã‚¿å‰Šé™¤</button>
  </div>
  <div id="status" style="font-size:12px;color:#555;margin-top:6px;">æº–å‚™OK</div>
</div>

<!-- çµæœã‚«ãƒ¼ãƒ‰ -->
<div class="cards">
  <div class="card"><h3>çŸ­æœŸï¼ˆ15åˆ†ï¼‰</h3><div id="pred15" class="kv">-</div><div id="trend15">-</div><pre id="rat15" class="rationale"></pre><div class="progress-bar-fill" id="bar15" style="width:0%;"></div></div>
  <div class="card"><h3>ä¸­æœŸï¼ˆ1æ™‚é–“ï¼‰</h3><div id="pred60" class="kv">-</div><div id="trend60">-</div><pre id="rat60" class="rationale"></pre><div class="progress-bar-fill" id="bar60" style="width:0%;"></div></div>
  <div class="card"><h3>é•·æœŸï¼ˆ4æ™‚é–“ï¼‰</h3><div id="pred240" class="kv">-</div><div id="trend240">-</div><pre id="rat240" class="rationale"></pre><div class="progress-bar-fill" id="bar240" style="width:0%;"></div></div>
</div>

<!-- ãƒãƒ£ãƒ¼ãƒˆ -->
<div class="panel"><canvas id="chart" height="360"></canvas></div>

</main>
<footer>Â© USD/JPY Predictor â€” iPhone Full Feature (CPU backend)</footer>

<script>
/* --- ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ç¾¤ --- */
const $=id=>document.getElementById(id);
const mean=a=>a.reduce((x,y)=>x+y,0)/a.length;
const std=a=>{const m=mean(a);return Math.sqrt(mean(a.map(v=>(v-m)**2)))||1e-8;}
const isNum=v=>Number.isFinite(v);

/* --- IndexedDBå‡¦ç† --- */
let db;const STORE="bars15";
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open("usd_jpy_iosdb",1);
r.onupgradeneeded=e=>{const d=e.target.result;if(!d.objectStoreNames.contains(STORE)){d.createObjectStore(STORE,{keyPath:"ts"});}};
r.onsuccess=()=>res(r.result);r.onerror=()=>rej(r.error);});}
function withStore(mode,fn){return new Promise((res,rej)=>{const tx=db.transaction(STORE,mode);const s=tx.objectStore(STORE);const p=fn(s);tx.oncomplete=()=>res(p);tx.onerror=e=>rej(e);});}
async function dbPut(rows){return withStore("readwrite",s=>rows.forEach(b=>s.put(b)));}

/* --- Chart --- */
let chart;
function drawChart(labels,values){if(chart)chart.destroy();
chart=new Chart($("chart"),{type:"line",data:{labels,datasets:[{label:"USD/JPY",data:values,borderColor:"#007bff",pointRadius:0,tension:0.2}]},options:{responsive:true,maintainAspectRatio:false}});}

/* --- ãƒ¡ã‚¤ãƒ³æ©Ÿèƒ½ï¼ˆBiLSTMã¯CPUä¸Šã§å®Ÿè¡Œï¼‰ --- */
async function fetchYahoo(){
  const url=`https://api.allorigins.win/raw?url=${encodeURIComponent("https://query1.finance.yahoo.com/v7/finance/chart/USDJPY=X?range=5d&interval=15m&indicators=quote&includeTimestamps=true")}`;
  const res=await fetch(url);const j=await res.json();const r=j.chart.result[0];
  return r.timestamp.map((t,i)=>({ts:t*1000,close:r.indicators.quote[0].close[i]}));
}

let closes=[],times=[];
async function initData(){
  $("status").textContent="å–å¾—ä¸­â€¦";
  const data=await fetchYahoo();await dbPut(data);
  closes=data.map(d=>d.close);times=data.map(d=>new Date(d.ts).toLocaleTimeString("ja-JP",{hour:"2-digit",minute:"2-digit"}));
  drawChart(times,closes);$("status").textContent=`å–å¾—å®Œäº† ${closes.length}ä»¶`;
}

async function predictAndTrain(){
  if(closes.length<64){alert("ãƒ‡ãƒ¼ã‚¿ä¸è¶³");return;}
  $("status").textContent="å­¦ç¿’ä¸­ï¼ˆCPUï¼‰â€¦";
  const look=parseInt($("lookback").value)||64;const lr=parseFloat($("lr").value)||0.001;const epochs=parseInt($("epochs").value)||18;
  const X=[],Y=[];for(let i=0;i<closes.length-look-1;i++){X.push(closes.slice(i,i+look));Y.push(closes[i+look]);}
  const tx=tf.tensor3d(X.map(x=>x.map(v=>[v])));const ty=tf.tensor2d(Y,[Y.length,1]);
  const m=tf.sequential();m.add(tf.layers.lstm({units:32,inputShape:[look,1]}));
  m.add(tf.layers.dense({units:1}));m.compile({optimizer:tf.train.adam(lr),loss:"meanSquaredError"});
  await m.fit(tx,ty,{epochs,verbose:0});
  const p=await m.predict(tf.tensor3d([closes.slice(-look).map(v=>[v])])).array();
  const pred=p[0][0];
  $("pred15").textContent=pred.toFixed(4);
  $("trend15").textContent=pred>closes.at(-1)?"ä¸Šæ˜‡ğŸ“ˆ":"ä¸‹é™ğŸ“‰";
  $("status").textContent="å®Œäº†";
  m.dispose();tx.dispose();ty.dispose();
}

/* --- ãƒœã‚¿ãƒ³å‹•ä½œ --- */
$("initBtn").onclick=async()=>{db=await openDB();await initData();}
$("startBtn").onclick=predictAndTrain;
$("clearBtn").onclick=async()=>{if(confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")){await withStore("readwrite",s=>s.clear());$("status").textContent="DBåˆæœŸåŒ–";}}
</script>
</body>
</html>
